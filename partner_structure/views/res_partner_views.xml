<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!--
    ==================CUSTOM PARTNER FORM VIEW==============================
  -->
    <record id="view_partner_form" model="ir.ui.view">
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form" />
        <field name="arch" type="xml">
            <!-- ======================== CUSTOM FIELDS ============================= -->
            <!-- Add a structure_type selection on top -->
            <xpath expr="//field[@name='company_type']" position="before">
                <div>
                    <field name="is_structure" invisible="1" />
                    <field
                        name="structure_type"
                        options="{'horizontal': true}"
                        class="o_field_radio o_horizontal o_field_widget oe_edit_only"
                        widget="radio"
                    />
                </div>
            </xpath>
            <!-- Change parent_id's domain to avoid Structures -->
            <xpath expr="//field[@name='parent_id']" position="attributes">
                <attribute
                    name="domain"
                >[('is_structure', '=', False), ('is_company', '=', True)]</attribute>
            </xpath>
            <!-- MOVE category_id field-->
            <field name="category_id" position="replace" />
            <xpath expr="//field[@name='parent_id']" position="after">
                <field
                    name="category_id"
                    widget="many2many_tags"
                    options="{'color_field': 'color'}"
                    placeholder="Tags..."
                    class="col-12"
                    domain="[('category_type_id', 'in', context.get('category_domain'))]"
                    context="{'default_category_type_id': context.get('default_category_type')}"
                />
            </xpath>
            <!-- ================  Put all the type, address and vat inside a group   ==========================-->
            <!-- 1) remove all the actual group's fields -->
            <field name="type" position="replace" />
            <field name="street" position="replace" />
            <field name="street2" position="replace" />
            <field name="city" position="replace" />
            <field name="state_id" position="replace" />
            <field name="zip" position="replace" />
            <field name="country_id" position="replace" />
            <field name="vat" position="replace" />
            <label for="street" position="replace" />
            <xpath expr="//label[@for='street']" position="attributes">
                <attribute name="invisible">True</attribute>
            </xpath>
            <xpath expr="//div[hasclass('o_address_format')]/.." position="attributes">
                <!-- This will let a residual 'div' in the fields_view_get. Invisible, but still there... -->
                <attribute name="invisible">True</attribute>
            </xpath>
            <!-- 2) create the new group -->
            <xpath expr="//field[@name='phone']/../.." position="before">
                <group>
                    <group class="w-100">
                        <field
                            name="type"
                            attrs="{'invisible': [('parent_id','=', False)]}"
                            groups="base.group_no_one"
                        />
                        <label for="street" string="Address" />
                        <div class="o_address_format">
                            <div
                                attrs="{'invisible': ['|', ('parent_id', '=', False), ('type', '!=', 'contact')]}"
                                class="oe_edit_only"
                            >
                                <b>Company Address:</b>
                            </div>
                            <field
                                name="street"
                                placeholder="Street..."
                                class="o_address_street"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                            />
                            <field
                                name="street2"
                                placeholder="Street 2..."
                                class="o_address_street"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                            />
                            <field
                                name="city"
                                placeholder="City"
                                class="o_address_city"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                            />
                            <field
                                name="state_id"
                                class="o_address_state"
                                placeholder="State"
                                options="{&quot;no_open&quot;: True}"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                                context="{'country_id': country_id, 'zip': zip}"
                            />
                            <field
                                name="zip"
                                placeholder="ZIP"
                                class="o_address_zip"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                            />
                            <field
                                name="country_id"
                                placeholder="Country"
                                class="o_address_country"
                                options="{&quot;no_open&quot;: True, &quot;no_create&quot;: True}"
                                attrs="{'readonly': [('type', '=', 'contact'),('parent_id', '!=', False)]}"
                            />
                        </div>
                        <field
                            name="vat"
                            placeholder="e.g. BE0477472701"
                            attrs="{'readonly': [('parent_id','!=',False)]}"
                        />
                    </group>
                    <!-- ADD Special Structure fields-->
                    <group
                        attrs="{'invisible': [('is_structure', '=', False)]}"
                        class="w-100"
                    >
                        <field name="structure_capacity" widget="selection" />
                        <!-- Structure date fields not for venues -->
                        <label
                            for="struct_date_begin"
                            attrs="{'invisible': [('structure_type', '=', 'venue')]}"
                        />
                        <div
                            attrs="{'invisible': [('structure_type', '=', 'venue')]}"
                            class="o_row"
                        >
                            <field name="struct_date_begin" />
                            <span
                                attrs="{'invisible': [('struct_date_end', '=', False)]}"
                                class="oe_read_only"
                            > - </span>
                            <span class="oe_edit_only"> - </span>
                            <field name="struct_date_end" />
                        </div>
                    </group>
                </group>
            </xpath>
            <!-- Hide mobile for Structure -->
            <xpath expr="//label[@for='mobile']" position="attributes">
                <attribute
                    name="attrs"
                >{'invisible': [('is_structure', '=', True)]}</attribute>
            </xpath>
            <xpath expr="//field[@name='mobile']/.." position="attributes">
                <attribute
                    name="attrs"
                >{'invisible': [('is_structure', '=', True)]}</attribute>
            </xpath>
            <!--
                ===================== CUSTOM M2M, PAGE and CHILDS =====================
            -->
            <!-- MANY2MANY Related Structure if partner is NOT a structure -->
            <xpath expr="//div[hasclass('oe_title')]" position="after">
                <group attrs="{'invisible': [('is_structure', '=', True)]}">
                    <field
                        name="related_structure_ids"
                        mode="kanban"
                        domain="[('is_structure', '=', True)]"
                        context="{'default_related_partner_ids': [id], 'default_structure_type': 'festival', 'default_is_structure': True, 'default_street': street, 'default_street2': street2, 'default_city': city, 'default_state_id': state_id, 'default_zip': zip, 'default_country_id': country_id, 'default_customer': customer, 'default_user_id': user_id}"
                    >
                        <kanban>
                            <field name="id" />
                            <field name="category_id" />
                            <field name="color" />
                            <field name="name" />
                            <field name="title" />
                            <field name="type" />
                            <field name="is_company" />
                            <field name="city" />
                            <field name="country_id" />
                            <field name="website" />
                            <field name="image_small" />
                            <templates>
                                <t t-name="kanban-box">
                                    <t
                                        t-set="color"
                                        t-value="kanban_color(record.color.raw_value)"
                                    />
                                    <div
                                        t-att-class="color + (record.title.raw_value == 1 ? ' oe_kanban_color_alert' : '') + ' oe_kanban_global_click'"
                                    >
                                        <div class="o_kanban_image">
                                            <img
                                                alt=""
                                                t-if="record.image_small.raw_value"
                                                t-att-src="kanban_image('res.partner', 'image_small', record.id.raw_value)"
                                            />
                                            <t t-if="!record.image_small.raw_value">
                                                <t
                                                    t-if="record.type.raw_value !== 'invoice' &amp;&amp; record.type.raw_value !== 'delivery'"
                                                >
                                                    <img
                                                        alt="Logo"
                                                        t-if="record.is_company.raw_value === true"
                                                        t-att-src="_s + &quot;/base/static/img/company_image.png&quot;"
                                                    />
                                                    <img
                                                        alt="Avatar"
                                                        t-if="record.is_company.raw_value === false"
                                                        t-att-src="_s + &quot;/base/static/img/avatar.png&quot;"
                                                    />
                                                </t>
                                            </t>
                                        </div>
                                        <div class="oe_kanban_details">
                                            <field name="name" />
                                            <div t-if="record.category_id.raw_value">
                                                <field
                                                    name="category_id"
                                                    widget="many2many_tags"
                                                    options="{'color_field': 'color', 'no_create_edit': True, 'no_create': True}"
                                                />
                                            </div>
                                            <div class="o_row">
                                                <div t-if="record.city.raw_value">
                                                    <field name="city" />
                                                </div>
                                                <div t-if="record.country_id.raw_value">
                                                    <field name="country_id" />
                                                </div>
                                            </div>
                                            <div t-if="record.website.raw_value">
                                                <field name="website" widget="url" />
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </templates>
                        </kanban>
                    </field>
                </group>
            </xpath>
            <!-- HIDE 'Contacts & Address' page if the partner is a structure or an individual -->
            <xpath expr="//field[@name='child_ids']/.." position="attributes">
                <field name="is_company" invisible="1" />
                <attribute
                    name="attrs"
                >{'invisible': ['|', ('is_structure', '=', True), ('is_company', '=', False)]}</attribute>
            </xpath>
            <!-- MANY2MANY 'Related Contacts' page if the partner is a structure -->
            <xpath expr="//field[@name='child_ids']/.." position="before">
                <page
                    string="Related Contacts"
                    attrs="{'invisible': [('is_structure', '=', False)]}"
                    autofocus="autofocus"
                >
                    <group>
                        <field
                            name="related_partner_ids"
                            nolabel="1"
                            domain="[('is_structure', '=', False )]"
                            context="{'partner_tag': True}"
                        >
                            <tree>
                                <field name="active" invisible="1" />
                                <field name="sequence" widget="handle" />
                                <field name="display_name" string="Name" />
                                <field name="function" />
                                <field name="email" />
                                <field name="phone" />
                                <field name="mobile" />
                                <control>
                                    <create string="Add a Contact" />
                                </control>
                            </tree>
                        </field>
                    </group>
                    <!-- TODO : [WIP] Add a button to add Related Contact without clicking on 'Edit'  -->
                    <!-- <button
            type="object"
            name="action_add_related_partner"
            string="Add a Related Contact"
            /> -->
                </page>
            </xpath>
            <!-- CUSTOM partners childs creation -->
            <xpath
                expr="//field[@name='child_ids']/form/sheet/field[@name='type']"
                position="before"
            >
                <field name="is_structure" invisible="1" />
                <field
                    name="company_type"
                    widget="radio"
                    class="oe_edit_only"
                    options="{'horizontal': true}"
                    string="Is Company?"
                />
                <hr class="oe_edit_only" />
            </xpath>
            <xpath expr="//field[@name='child_ids']" position="attributes">
                <attribute name="context">
          {
              'default_parent_id': active_id,
              'default_is_structure': False,
              'default_street': street,
              'default_street2': street2,
              'default_city': city,
              'default_state_id': state_id,
              'default_zip': zip,
              'default_country_id': country_id,
              'default_supplier': supplier,
              'default_customer': customer,
              'default_lang': lang,
              'default_user_id': user_id,
          }
        </attribute>
            </xpath>
            <xpath
                expr="//field[@name='child_ids']/form/sheet/group/group/field[@name='title']"
                position="attributes"
            >
                <attribute
                    name="attrs"
                >{'invisible': [('company_type', '=', 'company')]}</attribute>
            </xpath>
            <xpath
                expr="//field[@name='child_ids']/form/sheet/group/group/field[@name='function']"
                position="attributes"
            >
                <attribute
                    name="attrs"
                >{'invisible': [('company_type', '=', 'company')]}</attribute>
            </xpath>
        </field>
    </record>
</odoo>
